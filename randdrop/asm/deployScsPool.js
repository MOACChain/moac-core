/*
 * Example to deploy the SCS pool contract for RandDrop AppChain.
 * The smart contract SCSProtocolBse.sol is precompiled to prevent any compiler issues.
 * 
 * Solidity compiler v0.4.24 is suggested to use for compiling contract.
 * 
 * Require:
 * 1. A valid account keystore with password to deploy the Contract on the MOAC BaseChain;
 * 2. A running VNODE can connect and send Transaction to, need turn on personal in rpc api;
 *    --rpcapi "chain3,mc,net,vnode,personal"
 * 
 * Usage:
 *   node deployScsPool.js
 * 
 * For AppChain related info, please check online documents:
 * English:
 * https://moac-docs.readthedocs.io/en/latest
 * 中文：
 * https://moacdocs-chn.readthedocs.io/zh_CN/latest
 */
const Chain3 = require('chain3');

// need to have a valid account to use for contracts deployment
var baseaddr = "";//keystore address
var basepsd = "";//keystore password



//===============Check the BaseChain connection===============================
// Setup VNODE server to send TX command and the SCS to monitor the AppChain

const vnodeUri = 'http://localhost:8545';// can be change to other urls

// Setup the provider and try to connect
let chain3 = new Chain3();
chain3.setProvider(new chain3.providers.HttpProvider(vnodeUri));

if(!chain3.isConnected()){
    throw new Error('unable to connect to moac vnode at ' + vnodeUri);
}else{
    console.log('connected to VNODE ' + vnodeUri);
    let balance = chain3.mc.getBalance(baseaddr);
    console.log('Check src account balance:' + baseaddr + ' has ' + balance*1e-18 + " MC");
}

//===============Deploy the contract ===============================
// Unlock the account to send the TX
chain3.personal.unlockAccount(baseaddr,basepsd);

// precompiled contract
// Deploy the AppChain protocol pool to allow SCS join the pool to form the AppChain 
var protocol = "bls";   //Name of the SCS pool, don't change
var minScsDeposit = 5 ;// SCS must pay more than this in the register function to get into the SCS pool
var _protocolType = 3 ; // type of the AppChain protocol, don't change

var scspoolbaseContract = chain3.mc.contract([{"constant":true,"inputs":[{"name":"addr","type":"address"}],"name":"approvalAddresses","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"scs","type":"address"},{"name":"amount","type":"uint256"}],"name":"releaseFromSubchain","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"setSubchainActiveBlock","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"withdrawRequest","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"addr","type":"address"}],"name":"approvalAmounts","outputs":[{"name":"","type":"uint256[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"scs","type":"address"}],"name":"register","outputs":[{"name":"","type":"bool"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"scs","type":"address"},{"name":"amount","type":"uint256"},{"name":"v","type":"uint8"},{"name":"r","type":"bytes32"},{"name":"s","type":"bytes32"}],"name":"approveBond","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"scs","type":"address"},{"name":"amount","type":"uint256"}],"name":"forfeitBond","outputs":[{"name":"","type":"bool"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"subChainLastActiveBlock","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"scsCount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"scsApprovalList","outputs":[{"name":"bondApproved","type":"uint256"},{"name":"bondedCount","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"PENDING_BLOCK_DELAY","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"scs","type":"address"},{"name":"subchain","type":"address"}],"name":"releaseRequest","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"scsArray","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"blk","type":"uint256"}],"name":"setSubchainExpireBlock","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"protocolType","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"subChainExpireBlock","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"scsList","outputs":[{"name":"from","type":"address"},{"name":"bond","type":"uint256"},{"name":"state","type":"uint256"},{"name":"registerBlock","type":"uint256"},{"name":"withdrawBlock","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"bondMin","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_addr","type":"address"}],"name":"isPerforming","outputs":[{"name":"res","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"thousandth","type":"uint256"},{"name":"minnum","type":"uint256"}],"name":"getSelectionTarget","outputs":[{"name":"target","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"targetnum","type":"uint256"}],"name":"getSelectionTargetByCount","outputs":[{"name":"target","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"subChainProtocol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"WITHDRAW_BLOCK_DELAY","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"protocol","type":"string"},{"name":"minScsDeposit","type":"uint256"},{"name":"_protocolType","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":false,"name":"scs","type":"address"}],"name":"Registered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"sender","type":"address"}],"name":"UnRegistered","type":"event"}]);
var scspoolbase = scspoolbaseContract.new(
   protocol,
   minScsDeposit,
   _protocolType,
   {
     from: baseaddr, 
     data: '0x606060405234156200001057600080fd5b6040516200178338038062001783833981016040528080518201919060200180519190602001805160006002559150600390508380516200005692916020019062000067565b50600491909155600855506200010c565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620000aa57805160ff1916838001178555620000da565b82800160010185558215620000da579182015b82811115620000da578251825591602001919060010190620000bd565b50620000e8929150620000ec565b5090565b6200010991905b80821115620000e85760008155600101620000f3565b90565b611667806200011c6000396000f3006060604052600436106101485763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416631aa887ca811461014d578063202cc5e1146101bf578063365bfb9e146101f5578063380e687a1461020a5780633ccfd60b1461021d57806341205305146102305780634420e4861461024f5780636220fb1d1461026357806364f3ef461461029157806367bd927e146102a85780636e62adcb146102d957806376a95e88146102ec57806399f874d8146103235780639adea80714610336578063aab319331461035b578063b8a167e61461038d578063bd8d4bd8146103a3578063c3a919d0146103b6578063c9a856a3146103d5578063cb7f82661461042f578063ce9d9bd714610442578063de42f13c14610461578063e17095a41461047a578063f21e6f7a14610490578063f9eae0201461051a575b600080fd5b341561015857600080fd5b61016c600160a060020a036004351661052d565b60405160208082528190810183818151815260200191508051906020019060200280838360005b838110156101ab578082015183820152602001610193565b505050509050019250505060405180910390f35b34156101ca57600080fd5b6101e1600160a060020a0360043516602435610612565b604051901515815260200160405180910390f35b341561020057600080fd5b6102086108c2565b005b341561021557600080fd5b6101e16108df565b341561022857600080fd5b6102086109aa565b341561023b57600080fd5b61016c600160a060020a0360043516610a45565b6101e1600160a060020a0360043516610b0d565b341561026e57600080fd5b6101e1600160a060020a036004351660243560ff60443516606435608435610c33565b6101e1600160a060020a0360043516602435610e1e565b34156102b357600080fd5b6102c7600160a060020a0360043516611115565b60405190815260200160405180910390f35b34156102e457600080fd5b6102c7611127565b34156102f757600080fd5b61030b600160a060020a036004351661112d565b60405191825260208201526040908101905180910390f35b341561032e57600080fd5b6102c7611146565b341561034157600080fd5b6101e1600160a060020a036004358116906024351661114b565b341561036657600080fd5b610371600435611265565b604051600160a060020a03909116815260200160405180910390f35b341561039857600080fd5b61020860043561128d565b34156103ae57600080fd5b6102c76112a8565b34156103c157600080fd5b6102c7600160a060020a03600435166112ae565b34156103e057600080fd5b6103f4600160a060020a03600435166112c0565b604051600160a060020a03909516855260208501939093526040808501929092526060840152608083019190915260a0909101905180910390f35b341561043a57600080fd5b6102c76112f9565b341561044d57600080fd5b6101e1600160a060020a03600435166112ff565b341561046c57600080fd5b6102c760043560243561134b565b341561048557600080fd5b6102c76004356113ad565b341561049b57600080fd5b6104a36113f3565b60405160208082528190810183818151815260200191508051906020019080838360005b838110156104df5780820151838201526020016104c7565b50505050905090810190601f16801561050c5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561052557600080fd5b6102c7611491565b6105356115ec565b61053d6115ec565b600160a060020a03831660009081526001602081905260408083209091015490518059106105685750595b90808252806020026020018201604052509150600090505b600160a060020a0384166000908152600160208190526040909120015481101561060b57600160a060020a03841660009081526001602052604090206002018054829081106105cb57fe5b600091825260209091200154600160a060020a03168282815181106105ec57fe5b600160a060020a03909216602092830290910190910152600101610580565b5092915050565b6000805b600160a060020a038416600090815260016020819052604090912001548110156108b857600160a060020a038481166000908152600160205260409020600201805433909216918390811061066757fe5b600091825260209091200154600160a060020a03161480156106bc5750600160a060020a03841660009081526001602052604090206003018054849190839081106106ae57fe5b906000526020600020900154145b156108b057600160a060020a0384166000908152600160208190526040909120805485900381559081018054600019019081905560029091018054909190811061070257fe5b6000918252602080832090910154600160a060020a0387811684526001909252604090922060020180549190921691908390811061073c57fe5b60009182526020808320919091018054600160a060020a031916600160a060020a039485161790559186168152600191829052604090209081015460039091018054909190811061078957fe5b6000918252602080832090910154600160a060020a0387168352600190915260409091206003018054839081106107bc57fe5b6000918252602080832090910192909255600160a060020a038616815260019182905260409020908101546002909101805490919081106107f957fe5b600091825260208083209091018054600160a060020a0319169055600160a060020a038616825260019081905260409091209081015460039091018054909190811061084157fe5b60009182526020808320909101829055600160a060020a038616825260019052604090206002018054906108799060001983016115fe565b50600160a060020a03841660009081526001602052604090206003018054906108a69060001983016115fe565b506001915061060b565b600101610616565b5060009392505050565b600160a060020a0333166000908152600560205260409020439055565b33600160a060020a031660009081526020819052604081206002015460011461090757600080fd5b600160a060020a033316600090815260016020819052604090912001541561092e57600080fd5b33600160a060020a03811660009081526020819052604090204360048201556002908101819055805460001901905561096690611497565b7f4803dcd528253b802a22997f7a3b15bcc6be53c1f2ba8f110aa26c25d652a68f33604051600160a060020a03909116815260200160405180910390a15060015b90565b6002600160a060020a0333166000908152602081905260409020600201541480156109f35750600160a060020a0333166000908152602081905260409020600401546121c00143115b15610a4357600160a060020a0333811660009081526020819052604090819020805460019091015492169180156108fc029151600060405180830381858888f193505050501515610a4357600080fd5b565b610a4d6115ec565b610a556115ec565b600160a060020a0383166000908152600160208190526040808320909101549051805910610a805750595b90808252806020026020018201604052509150600090505b600160a060020a0384166000908152600160208190526040909120015481101561060b57600160a060020a0384166000908152600160205260409020600301805482908110610ae357fe5b906000526020600020900154828281518110610afb57fe5b60209081029091010152600101610a98565b600160a060020a0381166000908152602081905260408120600201541580610b5057506001600160a060020a038316600090815260208190526040902060020154145b8015610b685750600454670de0b6b3a7640000023410155b1515610b7357600080fd5b610b7c8261158f565b600160a060020a03821660008181526020819052604090208054600160a060020a0319169091178155600201541515610bea57600160a060020a0382166000908152602081905260409020436003820155600019600482015560028054600190810190915534910155610c0c565b600160a060020a03821660009081526020819052604090206001018054340190555b6001600160a060020a0383166000908152602081905260409020600201555060015b919050565b600080610c3f876112ff565b1515610c4e5760009150610e14565b600287336040516c01000000000000000000000000600160a060020a0393841681028252919092160260148201526028016020604051808303816000865af11515610c9857600080fd5b50506040518051915050600160a060020a0387166001828787876040516000815260200160405260405193845260ff9092166020808501919091526040808501929092526060840192909252608090920191516020810390808403906000865af11515610d0457600080fd5b505060206040510351600160a060020a031614610d245760009150610e14565b600160a060020a038716600090815260016020818152604080842054918490529092200154908701901015610d5c5760009150610e14565b600160a060020a0387166000908152600160208190526040909120805488018155600201805490918101610d9083826115fe565b5060009182526020808320919091018054600160a060020a03191633600160a060020a0390811691909117909155891682526001908190526040909120600301805490918101610de083826115fe565b506000918252602080832091909101889055600160a060020a03891682526001908190526040909120810180548201905591505b5095945050505050565b6000805b600160a060020a038416600090815260016020819052604090912001548110156108b857600160a060020a0384811660009081526001602052604090206002018054339092169183908110610e7357fe5b600091825260209091200154600160a060020a0316148015610ec85750600160a060020a0384166000908152600160205260409020600301805484919083908110610eba57fe5b906000526020600020900154145b1561110d57600160a060020a03841660009081526001602081905260409091208054859003815590810180546000190190819055600290910180549091908110610f0e57fe5b6000918252602080832090910154600160a060020a03878116845260019092526040909220600201805491909216919083908110610f4857fe5b60009182526020808320919091018054600160a060020a031916600160a060020a0394851617905591861681526001918290526040902090810154600390910180549091908110610f9557fe5b6000918252602080832090910154600160a060020a038716835260019091526040909120600301805483908110610fc857fe5b6000918252602080832090910192909255600160a060020a0386168152600191829052604090209081015460029091018054909190811061100557fe5b600091825260208083209091018054600160a060020a0319169055600160a060020a038616825260019081905260409091209081015460039091018054909190811061104d57fe5b60009182526020808320909101829055600160a060020a038616825260019052604090206002018054906110859060001983016115fe565b50600160a060020a03841660009081526001602052604090206003018054906110b29060001983016115fe565b50600160a060020a038085166000908152602081905260409081902060010180548690039055339091169084156108fc0290859051600060405180830381858888f19350505050151561110457600080fd5b6001915061060b565b600101610e22565b60056020526000908152604090205481565b60025481565b6001602081905260009182526040909120805491015482565b600081565b6000805b600160a060020a038416600090815260016020819052604090912001548110156108b857600160a060020a0384811660009081526001602052604090206002018054918516918390811061119f57fe5b600091825260209091200154600160a060020a03161480156111e65750600160a060020a038316600090815260066020908152604080832054600590925290912054439101105b1561125d57600160a060020a038416600090815260016020526040902060030180548290811061121257fe5b6000918252602080832090910154600160a060020a03871683526001918290526040909220805492909203825581018054600019019081905560029091018054909190811061070257fe5b60010161114f565b600780548290811061127357fe5b600091825260209091200154600160a060020a0316905081565b600160a060020a033316600090815260066020526040902055565b60085481565b60066020526000908152604090205481565b60006020819052908152604090208054600182015460028301546003840154600490940154600160a060020a0390931693919290919085565b60045481565b600160a060020a03811660009081526020819052604081206002015460011480156113455750600160a060020a0382166000908152602081905260409020600301544390105b92915050565b600080603283101561135c57603292505b82600254101561136f5760ff915061060b565b506002546103e890840204828110156113855750815b60028054826101000281151561139757fe5b046001018115156113a457fe5b04949350505050565b6000816002541115156113c2575060ff610c2e565b6002805483610100028115156113d457fe5b046001018115156113e157fe5b049050801515610c2e57506000919050565b60038054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156114895780601f1061145e57610100808354040283529160200191611489565b820191906000526020600020905b81548152906001019060200180831161146c57829003601f168201915b505050505081565b6121c081565b600754805b600081111561158a5782600160a060020a03166007600183038154811015156114c157fe5b600091825260209091200154600160a060020a03161415611581576007805460001984019081106114ee57fe5b60009182526020909120015460078054600160a060020a0390921691600019840190811061151857fe5b60009182526020909120018054600160a060020a031916600160a060020a039290921691909117905560078054600019840190811061155357fe5b60009182526020909120018054600160a060020a0319169055600780549061157f9060001983016115fe565b505b6000190161149c565b505050565b600160a060020a03811660009081526020819052604090206002015415156115e95760078054600181016115c383826115fe565b5060009182526020909120018054600160a060020a031916600160a060020a0383161790555b50565b60206040519081016040526000815290565b81548183558181151161158a5760008381526020902061158a9181019083016109a791905b808211156116375760008155600101611623565b50905600a165627a7a723058200a749721f5b6f398f69bf4039c420a9dd8d618862a2d09c7e2aca0669046b9f80029', 
     gas: '4700000'
   })

console.log("SCS protocol is being deployed at transaction HASH: " + scspoolbase.transactionHash);

// Lock the account after use
chain3.personal.lockAccount(baseaddr);

