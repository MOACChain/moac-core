/*
 * Example to deploy the VNODE pool contract for RandDrop AppChain.
 * The smart contract VnodeProtocolBse.sol is precompiled to prevent any compiler issues.
 * 
 * Solidity compiler v0.4.24 is suggested to use for compiling contract.
 * 
 * Require:
 * 1. A valid account keystore with password to deploy the Contract on the MOAC BaseChain;
 * 2. A running VNODE can connect and send Transaction to, need turn on personal in rpc api;
 *    --rpcapi "chain3,mc,net,vnode,personal"
 * 
 * Usage:
 *   node deployVnodePool.js
 * 
 * For AppChain related info, please check online documents:
 * English:
 * https://moac-docs.readthedocs.io/en/latest
 * 中文：
 * https://moacdocs-chn.readthedocs.io/zh_CN/latest
 */

const Chain3 = require('chain3');

// need to have a valid account to use for contracts deployment
var baseaddr = "";//keystore address
var basepsd = "";//keystore password


//===============Check the BaseChain connection===============================
// Setup VNODE server to send TX command and the SCS to monitor the AppChain

const vnodeUri = 'http://localhost:8545';// can be change to other urls

// Setup the provider and try to connect
let chain3 = new Chain3();
chain3.setProvider(new chain3.providers.HttpProvider(vnodeUri));

if(!chain3.isConnected()){
    throw new Error('unable to connect to moac vnode at ' + vnodeUri);
}else{
    console.log('connected to VNODE ' + vnodeUri);
    let balance = chain3.mc.getBalance(baseaddr);
    console.log('Check src account balance:' + baseaddr + ' has ' + balance*1e-18 + " MC");
}

//===============Deploy the contract ===============================
// Unlock the account to send the TX
chain3.personal.unlockAccount(baseaddr,basepsd);

var bmin = 1/* var of type uint256 here */ ;
var vnodeprotocolbaseContract = chain3.mc.contract([{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"vnodeList","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"randness","type":"uint256"}],"name":"pickRandomVnode","outputs":[{"name":"target","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"withdrawRequest","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"vnodeCount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"vnode","type":"address"},{"name":"via","type":"address"},{"name":"link","type":"string"},{"name":"rpclink","type":"string"}],"name":"register","outputs":[{"name":"","type":"bool"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"PEDNING_BLOCK_DELAY","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"uint256"}],"name":"outageReportList","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"level","type":"uint256"},{"name":"startpos","type":"uint256"},{"name":"count","type":"uint256"}],"name":"sweepOutage","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"bondMin","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_addr","type":"address"}],"name":"isPerforming","outputs":[{"name":"res","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"vnodeStore","outputs":[{"name":"from","type":"address"},{"name":"bond","type":"uint256"},{"name":"state","type":"uint256"},{"name":"registerBlock","type":"uint256"},{"name":"withdrawBlock","type":"uint256"},{"name":"rpclink","type":"string"},{"name":"via","type":"address"},{"name":"link","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"vnode","type":"address"}],"name":"reportOutage","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"WITHDRAW_BLOCK_DELAY","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"bmin","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"}]);
var vnodepoolbase = vnodeprotocolbaseContract.new(
   bmin,
   {
     from: baseaddr, 
     data: '0x606060405234156200001057600080fd5b604051602080620019b58339810160405280805191506200003290506200018f565b600060028190556003839055808252602082015260016040808301919091524360320160608301526000196080830152602090519081016040908152600080835260a084019290925260c0830191909152602090519081016040526000815260e082015260018054808201620000a98382620001ed565b6000928352602090922083916008020181518154600160a060020a031916600160a060020a03919091161781556020820151816001015560408201518160020155606082015181600301556080820151816004015560a0820151816005019080516200011a92916020019062000221565b5060c0820151600682018054600160a060020a031916600160a060020a039290921691909117905560e0820151816007019080516200015e92916020019062000221565b5050600280546001019055505060048054600160a060020a03191633600160a060020a0316179055506200039a9050565b610100604051908101604052806000600160a060020a0316815260200160008152602001600081526020016000815260200160008152602001620001d2620002a6565b815260006020820152604001620001e8620002a6565b905290565b8154818355818115116200021c576008028160080283600052602060002091820191016200021c9190620002b8565b505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200026457805160ff191683800117855562000294565b8280016001018555821562000294579182015b828111156200029457825182559160200191906001019062000277565b50620002a292915062000332565b5090565b60206040519081016040526000815290565b6200032f91905b80821115620002a2578054600160a060020a03191681556000600182018190556002820181905560038201819055600482018190556200030360058301826200034f565b600682018054600160a060020a0319169055620003256007830160006200034f565b50600801620002bf565b90565b6200032f91905b80821115620002a2576000815560010162000339565b50805460018160011615610100020316600290046000825580601f1062000377575062000397565b601f01602090049060005260206000209081019062000397919062000332565b50565b61160b80620003aa6000396000f3006060604052600436106100da5763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166301fd575b81146100df578063065a13f014610110578063380e687a1461019d5780633ccfd60b146101c45780635991e0ee146101d9578063676bea67146101ec5780637ff8fdaa1461028c5780638da5cb5b1461029f578063ab920301146102ce578063b08bcb1f146102f0578063cb7f82661461030c578063ce9d9bd71461031f578063dcd3cab21461033e578063ee8c9dd514610483578063f9eae020146104a2575b600080fd5b34156100ea57600080fd5b6100fe600160a060020a03600435166104b5565b60405190815260200160405180910390f35b341561011b57600080fd5b6101266004356104c7565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561016257808201518382015260200161014a565b50505050905090810190601f16801561018f5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156101a857600080fd5b6101b0610619565b604051901515815260200160405180910390f35b34156101cf57600080fd5b6101d761070e565b005b34156101e457600080fd5b6100fe610a9c565b6101b0600160a060020a036004803582169160248035909116919060649060443590810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528181529291906020840183838082843750949650610aa295505050505050565b341561029757600080fd5b6100fe610c28565b34156102aa57600080fd5b6102b2610c2d565b604051600160a060020a03909116815260200160405180910390f35b34156102d957600080fd5b6102b2600160a060020a0360043516602435610c3c565b34156102fb57600080fd5b6101d7600435602435604435610c73565b341561031757600080fd5b6100fe610ff2565b341561032a57600080fd5b6101b0600160a060020a0360043516610ff8565b341561034957600080fd5b6103546004356110a7565b6040518089600160a060020a0316600160a060020a031681526020018881526020018781526020018681526020018581526020018060200184600160a060020a0316600160a060020a0316815260200180602001838103835286818151815260200191508051906020019080838360005b838110156103dd5780820151838201526020016103c5565b50505050905090810190601f16801561040a5780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b83811015610440578082015183820152602001610428565b50505050905090810190601f16801561046d5780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390f35b341561048e57600080fd5b6101d7600160a060020a0360043516611253565b34156104ad57600080fd5b6100fe61133b565b60006020819052908152604090205481565b6104cf611341565b60006002805410156104f1576020604051908101604052600081529150610613565b600254838115156104fe57fe5b06905080151561050c576001015b61053d60018281548110151561051e57fe5b6000918252602090912060089091020154600160a060020a0316610ff8565b1561060157600180548290811061055057fe5b90600052602060002090600802016007018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156105f55780601f106105ca576101008083540402835291602001916105f5565b820191906000526020600020905b8154815290600101906020018083116105d857829003601f168201915b50505050509150610613565b60206040519081016040526000815291505b50919050565b600160a060020a033316600090815260208190526040812054819081901161064057600080fd5b50600160a060020a033316600081815260208190526040902054600180549192918390811061066b57fe5b6000918252602090912060089091020154600160a060020a03161461068f57600080fd5b60018080548390811061069e57fe5b9060005260206000209060080201600201541415156106bc57600080fd5b436001828154811015156106cc57fe5b6000918252602090912060046008909202010155600260018054839081106106f057fe5b906000526020600020906008020160020181905550600191505b5090565b600160a060020a033316600090815260208190526040812054819081901161073557600080fd5b600160a060020a03331660008181526020819052604090205460018054919450908490811061076057fe5b6000918252602090912060089091020154600160a060020a03161461078457600080fd5b6002600180548490811061079457fe5b9060005260206000209060080201600201541480156107d657506121c06001838154811015156107c057fe5b9060005260206000209060080201600401540143115b15610a985760018054839081106107e957fe5b600091825260209091206001600890920201810154600280546000190190819055825491935090811061081857fe5b600091825260209091206008909102015460018054600160a060020a03909216918490811061084357fe5b906000526020600020906008020160000160006101000a815481600160a060020a030219169083600160a060020a03160217905550600160025481548110151561088957fe5b9060005260206000209060080201600101546001838154811015156108aa57fe5b90600052602060002090600802016001018190555060016002548154811015156108d057fe5b9060005260206000209060080201600301546001838154811015156108f157fe5b906000526020600020906008020160030181905550600160025481548110151561091757fe5b90600052602060002090600802016004015460018381548110151561093857fe5b906000526020600020906008020160040181905550600160025481548110151561095e57fe5b906000526020600020906008020160070160018381548110151561097e57fe5b906000526020600020906008020160070190805460018160011615610100020316600290046109ae929190611353565b5060016002548154811015156109c057fe5b6000918252602082206008909102018054600160a060020a03191681556001810182905560028101829055600381018290556004810182905590610a0760058301826113d4565b600682018054600160a060020a0319169055610a276007830160006113d4565b505081600080600185815481101515610a3c57fe5b60009182526020808320600890920290910154600160a060020a03908116845290830193909352604091820190209290925533169082156108fc0290839051600060405180830381858888f193505050501515610a9857600080fd5b5050565b60025481565b6000610aac61141b565b600160a060020a038616600090815260208190526040902054158015610ade5750600354670de0b6b3a7640000023410155b1515610ae957600080fd5b600160a060020a038616815234602082015260016040820152436032016060820152600019608082015260a08101839052600160a060020a03851660c082015260e0810184905260018054808201610b418382611475565b6000928352602090922083916008020181518154600160a060020a031916600160a060020a03919091161781556020820151816001015560408201518160020155606082015181600301556080820151816004015560a082015181600501908051610bb09291602001906114a6565b5060c0820151600682018054600160a060020a031916600160a060020a039290921691909117905560e082015181600701908051610bf29291602001906114a6565b505060028054600160a060020a038a16600090815260208190526040902081905560019081019091559350505050949350505050565b603281565b600454600160a060020a031681565b600560205281600052604060002081815481101515610c5757fe5b600091825260209091200154600160a060020a03169150829050565b600454600090819033600160a060020a03908116911614610c9357600080fd5b600085118015610ca4575060058511155b1515610caf57600080fd5b600084118015610cc0575060025484105b1515610ccb57600080fd5b6002546000198585010192508210610ce65760016002540391505b50805b838110610feb578460056000600184815481101515610d0457fe5b60009182526020808320600890920290910154600160a060020a0316835282019290925260400190205410610fe25760056000600183815481101515610d4657fe5b60009182526020808320600890920290910154600160a060020a031683528201929092526040018120610d7891611514565b600280546000190190819055600180549091908110610d9357fe5b600091825260209091206008909102015460018054600160a060020a039092169183908110610dbe57fe5b906000526020600020906008020160000160006101000a815481600160a060020a030219169083600160a060020a031602179055506001600254815481101515610e0457fe5b906000526020600020906008020160010154600182815481101515610e2557fe5b9060005260206000209060080201600101819055506001600254815481101515610e4b57fe5b906000526020600020906008020160030154600182815481101515610e6c57fe5b9060005260206000209060080201600301819055506001600254815481101515610e9257fe5b906000526020600020906008020160040154600182815481101515610eb357fe5b9060005260206000209060080201600401819055506001600254815481101515610ed957fe5b9060005260206000209060080201600701600182815481101515610ef957fe5b90600052602060002090600802016007019080546001816001161561010002031660029004610f29929190611353565b506001600254815481101515610f3b57fe5b6000918252602082206008909102018054600160a060020a03191681556001810182905560028101829055600381018290556004810182905590610f8260058301826113d4565b600682018054600160a060020a0319169055610fa26007830160006113d4565b505080600080600184815481101515610fb757fe5b60009182526020808320600890920290910154600160a060020a031683528201929092526040019020555b60001901610ce9565b5050505050565b60035481565b600160a060020a038116600090815260208190526040812054151561101f575060006110a2565b6001600160a060020a03831660009081526020819052604090205460018054909190811061104957fe5b90600052602060002090600802016002015414801561109f5750600160a060020a03821660009081526020819052604090205460018054439290811061108b57fe5b906000526020600020906008020160030154105b90505b919050565b60018054829081106110b557fe5b90600052602060002090600802016000915090508060000160009054906101000a9004600160a060020a031690806001015490806002015490806003015490806004015490806005018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156111925780601f1061116757610100808354040283529160200191611192565b820191906000526020600020905b81548152906001019060200180831161117557829003601f168201915b5050505050908060060160009054906101000a9004600160a060020a031690806007018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156112495780601f1061121e57610100808354040283529160200191611249565b820191906000526020600020905b81548152906001019060200180831161122c57829003601f168201915b5050505050905088565b600160a060020a03811660009081526005602081905260408220541015610a98575060005b600160a060020a0382166000908152600560205260409020548110156112ea57600160a060020a03828116600090815260056020526040902080543390921691839081106112c257fe5b600091825260209091200154600160a060020a031614156112e257610a98565b600101611278565b600160a060020a03821660009081526005602052604090208054600181016113128382611532565b5060009182526020909120018054600160a060020a03191633600160a060020a03161790555050565b6121c081565b60206040519081016040526000815290565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061138c57805485556113c8565b828001600101855582156113c857600052602060002091601f016020900482015b828111156113c85782548255916001019190600101906113ad565b5061070a929150611552565b50805460018160011615610100020316600290046000825580601f106113fa5750611418565b601f0160209004906000526020600020908101906114189190611552565b50565b610100604051908101604052806000600160a060020a031681526020016000815260200160008152602001600081526020016000815260200161145c611341565b815260006020820152604001611470611341565b905290565b8154818355818115116114a1576008028160080283600052602060002091820191016114a1919061156f565b505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106114e757805160ff19168380011785556113c8565b828001600101855582156113c8579182015b828111156113c85782518255916020019190600101906114f9565b50805460008255906000526020600020908101906114189190611552565b8154818355818115116114a1576000838152602090206114a19181019083015b61156c91905b8082111561070a5760008155600101611558565b90565b61156c91905b8082111561070a578054600160a060020a03191681556000600182018190556002820181905560038201819055600482018190556115b660058301826113d4565b600682018054600160a060020a03191690556115d66007830160006113d4565b506008016115755600a165627a7a7230582090973e5adc7f1ebf474e3fcf6a1a34ec942c11e86a0dd6658a8800c20e4030610029', 
     gas: '4700000'
   })

console.log("VNODE protocol is being deployed at transaction HASH: " + vnodepoolbase.transactionHash);

// Lock the account after use
chain3.personal.lockAccount(baseaddr);
